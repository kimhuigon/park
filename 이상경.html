<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>가까운공원찾기</title>
  <style>
    #map {
      width: 500px;
      height: 400px;
    }
    #search-box {
      margin: 20px 0;
    }
    #results {
      list-style: none;
      padding: 0;
    }
    #results li {
      margin: 5px 0;
      padding: 5px;
      background: lightcoral;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="search-box">
    <input type="text" id="keyword" placeholder="Search places...">
    <button onclick="searchPlaces()">Search</button>
  </div>
  <div id="map"></div>
  <ul id="results"></ul>

  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6dfaf6fb0d9d9293c6bc9220328e7540&libraries=services"></script>
  <script type="text/javascript" src="parkdata.js"></script> <!-- parkdata.js 파일 불러오기 -->

  <script>
    let map;
    let currentMarker;
    let markers = [];
    let ps;
    let openInfoWindow = null;

    function initMap(lat, lng) {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(lat, lng),
        level: 3
      };
      map = new kakao.maps.Map(container, options);

      const markerPosition = new kakao.maps.LatLng(lat, lng);
      currentMarker = new kakao.maps.Marker({
        position: markerPosition,
        map: map,
        title: "현재 위치"
      });

      ps = new kakao.maps.services.Places();
    }

    function createMarker(lat, lng) {
      const imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
      const currentPosition = new kakao.maps.LatLng(lat, lng);

      function calculateDistance(parkPosition) {
        if (!(parkPosition instanceof kakao.maps.LatLng)) {
          console.error('Invalid park position:', parkPosition);
          return Number.MAX_VALUE;
        }
        const latDiff = parkPosition.getLat() - currentPosition.getLat();
        const lngDiff = parkPosition.getLng() - currentPosition.getLng();
        return Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
      }

      const sortedData = data.map(park => {
        return {
          ...park,
          위도: parseFloat(park.위도),
          경도: parseFloat(park.경도)
        };
      }).sort((a, b) => {
        const distanceA = calculateDistance(new kakao.maps.LatLng(a.위도, a.경도));
        const distanceB = calculateDistance(new kakao.maps.LatLng(b.위도, b.경도));
        return distanceA - distanceB;
      });

      clearMarkers();

      sortedData.slice(0, 5).forEach(park => {
        const markerPosition = new kakao.maps.LatLng(park.위도, park.경도);
        const marker = new kakao.maps.Marker({
          position: markerPosition,
          map: map,
          title: park.공원명,
          image: new kakao.maps.MarkerImage(imageSrc, new kakao.maps.Size(24, 35)),
        });

        const iwContent = `<div style="padding:5px;">${park.공원명}<br>
                            <a href="https://map.kakao.com/link/map/${park.공원명},${park.위도},${park.경도}" style="color:blue" target="_blank">큰지도보기</a>
                            <a href="https://map.kakao.com/link/to/${park.공원명},${park.위도},${park.경도}" style="color:blue" target="_blank">길찾기</a></div>`;
        const infowindow = new kakao.maps.InfoWindow({
          position: markerPosition,
          content: iwContent
        });

        kakao.maps.event.addListener(marker, 'click', () => {
          if (openInfoWindow) {
            openInfoWindow.close();
            if (openInfoWindow === infowindow) {
              openInfoWindow = null;
              return;
            }
          }
          infowindow.open(map, marker);
          openInfoWindow = infowindow;
        });

        markers.push(marker);
      });
    }

    function searchPlaces() {
      const keyword = document.getElementById('keyword').value;

      if (!keyword.trim()) {
        alert('키워드를 입력해주세요!');
        return;
      }

      ps.keywordSearch(keyword, placesSearchCB);
    }

    function placesSearchCB(data, status, pagination) {
      if (status === kakao.maps.services.Status.OK) {
        displayPlaces(data);
      } else {
        alert('검색 결과가 존재하지 않습니다.');
      }
    }

    function displayPlaces(places) {
      const listEl = document.getElementById('results');
      listEl.innerHTML = '';

      for (let i = 0; i < places.length; i++) {
        const itemEl = document.createElement('li');
        itemEl.innerHTML = places[i].place_name;
        itemEl.onclick = () => {
          const position = new kakao.maps.LatLng(places[i].y, places[i].x);
          map.setCenter(position);

          currentMarker.setPosition(position);
          createMarker(places[i].y, places[i].x);
        };
        listEl.appendChild(itemEl);
      }
    }

    function clearMarkers() {
      for (const marker of markers) {
        marker.setMap(null);
      }
      markers = [];
    }

    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      initMap(lat, lng);

      navigator.geolocation.watchPosition((pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        const newPosition = new kakao.maps.LatLng(lat, lng);
        currentMarker.setPosition(newPosition);
        map.setCenter(newPosition);
        createMarker(lat, lng);
      });
    });
  </script>
</body>
</html>
