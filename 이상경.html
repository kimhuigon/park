<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>가장 가까운 공원 찾기</title>
  <style>
    /* CSS 스타일링은 생략 */
  </style>
</head>
<body>
  <div id="map" style="width:500px;height:400px;"></div>

  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8b8be24d01d3c7bb07c87615edf72cbf"></script>
  <script type="text/javascript" src="parkdata.js"></script> <!-- data.js 파일 불러오기 -->

  <script>
    let map;
    let marker; 
    let markers = []; // 마커를 담을 배열

    function initMap(lat, lng) {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(lat, lng),
        level: 3
      };
      map = new kakao.maps.Map(container, options);
      //현재 위치 마커
      const markerPosition = new kakao.maps.LatLng(lat, lng);
      marker = new kakao.maps.Marker({
        position: markerPosition
      });
      marker.setMap(map);

      createMarker(lat, lng);
    }

    function createMarker(lat, lng) {
      const imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

      // 현재 위치
      const currentPosition = new kakao.maps.LatLng(lat, lng);

      // 공원과 현재 위치 간의 거리를 계산하는 함수
      function calculateDistance(parkPosition) {
        // parkPosition이 LatLng 객체인지 확인
        if (!(parkPosition instanceof kakao.maps.LatLng)) {
          console.error('Invalid park position:', parkPosition);
          return Number.MAX_VALUE; // 거리를 최대값으로 설정하여 이후 정렬에서 무시되도록 함
        }

        const latDiff = parkPosition.getLat() - currentPosition.getLat();
        const lngDiff = parkPosition.getLng() - currentPosition.getLng();
        return Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
      }

      // 공원 데이터를 거리순으로 정렬
      data.sort((a, b) => {
        const distanceA = calculateDistance(new kakao.maps.LatLng(a.위도, a.경도));
        const distanceB = calculateDistance(new kakao.maps.LatLng(b.위도, b.경도));
        return distanceA - distanceB;
      });

      // 현재 지도에 표시된 마커들을 모두 제거
      for (const marker of markers) {
        marker.setMap(null);
      }
      markers = []; // 마커 배열 초기화

      // 상위 5개의 공원을 표시
      data.slice(0, 5).forEach(park => {
        const markerPosition = new kakao.maps.LatLng(park.위도, park.경도);
        const marker = new kakao.maps.Marker({
          position: markerPosition,
          map: map,
          title: park.공원명,
          image: new kakao.maps.MarkerImage(imageSrc, new kakao.maps.Size(24, 35)),
        });
        markers.push(marker); // 마커를 배열에 추가
      });
    }

    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      initMap(lat, lng);

      // 현재 위치가 변경될 때마다 공원 다시 표시
      navigator.geolocation.watchPosition((pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        createMarker(lat, lng);
      });
    });
  </script>
</body>
</html>